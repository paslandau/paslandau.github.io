<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="How to use GCP MySQL Cloud SQL instances: Create instances, connect to them (via private or public IP) and delete them">
            <meta name="author" content="Pascal Landau">
        <title>Using GCP MySQL Cloud SQL instances (create/connect/delete) | pascallandau.com</title>
    <meta name="google-site-verification" content="fcW8afndMqg-HUmdh_fIAbz81qMkxVJA-Hogrg3UYEw"/>

    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link href="/css/clean-blog.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
    <!-- highlight.js -->
    <link rel="stylesheet" href="/css/default.min.css">
    <!-- RSS Feed -->
    <link rel="canonical" href="https://www.pascallandau.com/blog/gcp-mysql-cloud-sql-instances-create-connect-delete/"/>
            <meta name="robots" content="noindex"/>
        <link rel="alternate" type="application/rss+xml" title="pascallandau.com" href="https://www.pascallandau.com/feed.xml"/>
    <link rel="alternate" type="application/rss+xml" title="pascallandau.com - Finance related articles" href="https://www.pascallandau.com/feed-finance.xml"/>
    <!-- Custom Fonts -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || [];
            w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            });
            var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : '';
            j.async = true;
            j.src =
                'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-5B9NRTM');</script>
    <!-- End Google Tag Manager -->
</head>

<body>
<!-- Google Tag Manager (noscript) -->
<noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5B9NRTM"
            height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>
<!-- End Google Tag Manager (noscript) -->
<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse"
                    data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">
                <img src="/favicon.ico" />
                pascallandau.com
            </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right" id="navbar">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about/">About</a>
                </li>
                <li>
                    <a href="/blog/">Blog</a>
                </li>
                <li>
                    <a href="/blog/#newsletter">Newsletter</a>
                </li>
                <li>
                    <a href="/bigquery-snippets/">BigQuery Snippets</a>
                </li>
                <li>
                    <a href="/docker-php-tutorial/">Docker PHP Tutorial</a>
                </li>
                <li>
                    <a href="/personal-finance/">Personal Finance</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

<!-- Page Header -->
<!-- Set your background image for this header on the line below. -->
<header class="intro-header" style="background: #000
        ">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>How to use GCP MySQL Cloud SQL instances</h1>
                                            <h2 class="subheading">from creation over connection to deletion</h2>
                                                                <span class="meta">
                            <span style="display:block; margin:0;">
                                Posted by <a href="#">Pascal Landau</a> on 2022-09-01 06:00:00
                            </span>
                            <span style="display:block;">
                                <a href="https://twitter.com/PascalLandau">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-twitter fa-stack-1x"></i>
                                    </span>
                                </a>
                                <a href="https://www.linkedin.com/in/pascallandau">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-linkedin fa-stack-1x"></i>
                                    </span>
                                </a>
                                <a href="https://github.com/paslandau/">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-github fa-stack-1x"></i>
                                    </span>
                                </a>
                                <a href="https://www.youtube.com/channel/UC8hVNCGAtz1DvOOpSQ3Nfzw">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-youtube fa-stack-1x"></i>
                                    </span>
                                </a>
                            </span>
                        </span>
                                    </div>
            </div>
        </div>
    </div>
</header>

<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <strong>Caution</strong>
                        </div>
                        <div class="panel-body bg-danger">
                            This post is still in a <strong>draft</strong> status and likely subject to change!
                        </div>
                    </div>                    
                    
                <p>In this blog post I'll summarize my experience with <strong>GCP MySQL Cloud SQL instances</strong>. Cloud SQL 
is the managed relational database solution from Google Cloud Platform and was mentioned in 
<a href="/blog/deploy-docker-compose-php-gcp-poc/#introduction">Deploy dockerized PHP Apps to production on GCP via docker compose as a POC</a>
as the "better" way to deal with databases in a dockerized application (compared to running a 
database via <code>docker</code>).</p>

<div class="panel panel-default">
  <div class="panel-heading">
    <strong>What will you learn?</strong>
  </div>
  <div class="panel-body bg-info">
    I'll explain the basic steps to <strong>create a fresh MySQL instance</strong>, 
    <strong>show different ways to connect to it</strong> (Cloud Shell, locally "from your laptop" 
    and from a VM within GCP) and finally <strong>how to delete the instance</strong>. Every process 
    is done through the Cloud Console UI and <strong>recorded as a short video</strong> as a visual 
    aid. As in the <a href="/blog/gcp-compute-instance-vm-docker/">GCP "primer" tutorial</a>, this 
    article ends with the commands to achieve the same things also via the
    <code>gcloud</code> CLI.
  </div>
</div>

<p><!-- generated -->
<a id='table-of-contents'> </a>
<!-- /generated --></p>

<h2>Table of contents</h2>

<!-- toc -->

<ul>
<li><a href="#setup-cloud-sql">Setup Cloud SQL</a></li>
<li><a href="#create-a-new-mysql-instance">Create a new <code>mysql</code> instance</a></li>
<li><a href="#connecting-to-a-mysql-cloud-sql-instance">Connecting to a MySQL Cloud SQL instance</a>

<ul>
<li><a href="#connecting-to-the-mysql-instance-with-cloud-shell-via-public-ip">Connecting to the <code>mysql</code> instance with Cloud Shell via public IP</a></li>
<li><a href="#connecting-to-the-mysql-instance-via-public-ip">Connecting to the <code>mysql</code> instance via public IP</a></li>
<li><a href="#connecting-to-the-mysql-instance-via-private-ip">Connecting to the <code>mysql</code> instance via private IP</a>

<ul>
<li><a href="#concrete-steps-to-connect-via-private-ip">Concrete steps to connect via private IP</a></li>
<li><a href="#caveats-for-using-a-private-ip-only">Caveats for using a private IP only</a></li>
</ul></li>
</ul></li>
<li><a href="#delete-a-mysql-cloud-sql-instance">Delete a MySQL Cloud SQL instance</a></li>
<li><a href="#using-the-gcloud-cli">Using the <code>gcloud</code> CLI</a>

<ul>
<li><a href="#activate-the-service-account">Activate the service account</a></li>
<li><a href="#enable-the-necessary-apis">Enable the necessary APIs</a></li>
<li><a href="#create-an-ip-range-allocation">Create an IP range allocation</a></li>
<li><a href="#create-the-vpc-peering-with-servicenetworking-googleapis-com">Create the VPC peering with <code>servicenetworking.googleapis.com</code></a></li>
<li><a href="#create-the-mysql-instance">Create the <code>mysql</code> instance</a>

<ul>
<li><a href="#set-the-root-password">Set the root password</a></li>
<li><a href="#create-a-default-database">Create a default database</a></li>
</ul></li>
</ul></li>
</ul>

<!-- /toc -->

<p><!-- generated -->
<a id='setup-cloud-sql'> </a>
<!-- /generated --></p>

<h2>Setup Cloud SQL</h2>

<p><a href="/img/gcp-mysql-cloud-sql-instances-create-connect-delete/cloud-console-cloud-sql-ui.PNG"><img src="/img/gcp-mysql-cloud-sql-instances-create-connect-delete/cloud-console-cloud-sql-ui.PNG" alt="GCP Cloud Console Cloud SQL UI" /></a></p>

<p>The managed solution for relational databases from GCP is called 
<a href="https://cloud.google.com/sql">Cloud SQL</a> and provides multiple database technologies - 
including <a href="https://cloud.google.com/sql/mysql"><code>mysql</code></a>. In the Cloud Console UI it is managed 
via the <a href="https://console.cloud.google.com/sql">SQL UI</a> that allows us to create and manage 
instances.</p>

<p><!-- generated -->
<a id='create-a-new-mysql-instance'> </a>
<!-- /generated --></p>

<h2>Create a new <code>mysql</code> instance</h2>

<p>To get started, we need to enable the following APIs:</p>

<ul>
<li><a href="https://console.cloud.google.com/apis/library/compute.googleapis.com">Compute Engine API</a></li>
<li><a href="https://console.cloud.google.com/apis/library/sqladmin.googleapis.com">Cloud SQL Admin API</a></li>
</ul>

<p>Creating a new instance from the 
<a href="https://console.cloud.google.com/sql/instances/create;engine=MySQL">Create a MySQL instance UI</a>
is pretty straight forward and well documented in the 
<a href="https://cloud.google.com/sql/docs/mysql/create-instance?hl=en">GCP MySQL Guide: Create instances</a>, 
though there are some configuration options under "Customize your instance" that I want to mention:</p>

<ul>
<li><code>Machine type &gt; Machine type</code>: For testing purposes, I recommend choosing a "Shared core" 
option here (e.g. 1 vCPU, 0.614 GB) to keep the costs to a minimum</li>
<li><code>Connections &gt; Instance IP assignment</code>: For now we'll go with a "Public IP", because 
<a href="#connecting-to-the-mysql-instance-via-private-ip">setting up private connectivity requires some additional configuration</a></li>
<li><code>Data Protection &gt; Instance deletion protection</code>: When the option 
<code>Enable deletion protection</code> is enabled, the instance cannot be deleted. The option must first 
be disabled before this is possible (see also
<a href="#delete-a-mysql-cloud-sql-instance">Delete a Cloud SQL instance</a>).</li>
</ul>

<p>FYI: Unfortunately, there is no <code>"EQUIVALENT COMMAND LINE"</code> button as it was the case when 
<a href="/blog/gcp-compute-instance-vm-docker/#create-a-compute-instance-vm">creating the Compute Instance</a> -
which would have come in handy for 
<a href="#create-the-mysql-instance">creating the instance via <code>gcloud</code> cli</a>.</p>

<p>Once everything is configured, click the <code>"Create Instance"</code> button. The actual creation can 
take quite some time (I've experienced times from a couple of minutes to half an hour).</p>

<video controls>
  <source src="/img/gcp-mysql-cloud-sql-instances-create-connect-delete/create-gcp-mysql-cloud-sql-instance.mp4" type="video/mp4">
Your browser does not support the video tag.
</video>

<p><!-- generated -->
<a id='connecting-to-a-mysql-cloud-sql-instance'> </a>
<!-- /generated --></p>

<h2>Connecting to a MySQL Cloud SQL instance</h2>

<p>I'll explain 3 different ways of <strong>connecting to a MySQL Cloud SQL instance</strong>:</p>

<ul>
<li>via Cloud Shell (requires a public instance IP)</li>
<li>"locally" from your laptop (requires a public instance IP)</li>
<li>from a Compute Instance VM on GCP (requires a private instance IP)</li>
</ul>

<p>Out of scope:</p>

<ul>
<li>using the <a href="https://cloud.google.com/sql/docs/mysql/sql-proxy">Cloud SQL Auth proxy</a></li>
</ul>

<p>As always, GCP has also an extensive documentation on the various connection methods available at
<a href="https://cloud.google.com/sql/docs/mysql/connect-overview">GCP MySQL Guide: About connection options</a>.</p>

<p><!-- generated -->
<a id='connecting-to-the-mysql-instance-with-cloud-shell-via-public-ip'> </a>
<!-- /generated --></p>

<h3>Connecting to the <code>mysql</code> instance with Cloud Shell via public IP</h3>

<p>The easiest way to connect is through <a href="https://cloud.google.com/shell">Cloud Shell</a>. GCP will 
spin up a VM "behind the scenes" that we can control via shell session in the browser. Navigate 
to the management UI of the instance at</p>

<pre><code class="language-text">https://console.cloud.google.com/sql/instances/$instanceName/overview

# e.g. for an instance named 'mysql-1'
# https://console.cloud.google.com/sql/instances/mysql-1/overview 
</code></pre>

<p>and click the <code>"OPEN CLOUD SHELL"</code> button in panel "Connect to this instance".</p>

<video controls>
  <source src="/img/gcp-mysql-cloud-sql-instances-create-connect-delete/cloud-shell-mysql.mp4" type="video/mp4">
Your browser does not support the video tag.
</video>

<p>Please note the</p>

<pre><code>Allowlisting your IP for incoming connection for 5 minutes...working.
</code></pre>

<p>step in the video: GCP handles all the "networking stuff" to make the connection possible for us.</p>

<p><!-- generated -->
<a id='connecting-to-the-mysql-instance-via-public-ip'> </a>
<!-- /generated --></p>

<h3>Connecting to the <code>mysql</code> instance via public IP</h3>

<p>Even though the instance has a public IP address (<code>104.198.240.225</code> in this case, as shown in 
the previous video), we can't simply connect to it via</p>

<pre><code class="language-text">$ mysql -u root -p12345678 -h 104.198.240.225
# ... the request will simply time out
</code></pre>

<p><a href="https://cloud.google.com/sql/docs/mysql/authorize-networks?hl=en#limitations">due to firewall rules</a>:</p>

<blockquote>
  <p>Note: The authorized networks list is implemented on the Cloud SQL instance VM by a local 
  firewall. Learn more about managing connections.</p>
</blockquote>

<p>If we want to connect from e.g. our own computer, we need to first create a so-called 
"Authorized network" as described in the
<a href="https://cloud.google.com/sql/docs/mysql/authorize-networks?hl=en">GCP MySQL Guide: Authorize with authorized networks</a>.</p>

<p>For testing purposes I'll 
<a href="https://www.cyberciti.biz/faq/how-to-find-my-public-ip-address-from-command-line-on-a-linux/">retrieve my own public IP address</a>
via <code>wget -q -O - ifconfig.me</code></p>

<pre><code class="language-text">$ wget -q -O - ifconfig.me
213.21.32.150
</code></pre>

<p>and edit the <code>mysql</code> instance to <strong>add only this IP address as an Authorized network</strong>. The 
following video shows that the connection isn't possible before I added the Authorized network 
but will be afterwards.</p>

<video controls>
  <source src="/img/gcp-mysql-cloud-sql-instances-create-connect-delete/connect-from-localhost-to-cloud-sql-mysql.mp4" type="video/mp4">
Your browser does not support the video tag.
</video>

<p><strong>CAUTION</strong>: Please regard this <em>only as a proof of concept</em>. It's not really a viable process to 
retrieve your own public IP in order to allowlist it "manually". It might be "okay" though, if 
you are using a VPN with a static IP. However, for the 
<a href="/docker-php-tutorial/">Docker PHP tutorial</a> we'll not use a public IP address at all, because 
our <code>mysql</code> instance should only be available for our application VMs.</p>

<p><!-- generated -->
<a id='connecting-to-the-mysql-instance-via-private-ip'> </a>
<!-- /generated --></p>

<h3>Connecting to the <code>mysql</code> instance via private IP</h3>

<p>Having the MySQL Cloud SQL instance exposed via public IP is generally not advised and 
always carries a certain security risk. Thus, it is desirable <strong>to only allow connections via 
private IP</strong>. Be aware that this has some caveats, though (see section 
<a href="#caveats-for-using-a-private-ip-only">Caveats for using a private IP only</a>).</p>

<p>In order to <strong>connect to the MySQL Cloud SQL instance via private IP</strong> (i.e. from a Compute 
Instance VM), we must first understand how the network configuration of the "managed" products 
of GCP is set up. This is explained in detail in the 
<a href="https://cloud.google.com/sql/docs/mysql/private-ip">GCP MySQL Guide: Learn about using private IP</a>. 
In short:</p>

<ul>
<li>we use <strong>a private network that allows all of our VMs to communicate</strong></li>
<li>such a network is called <strong><a href="https://cloud.google.com/vpc">VPC</a> (virtual private cloud)</strong></li>
<li>since "we" (as a user of GCP) create and manage our application VMs ourselves, <strong>the VMs live 
"directly" in this network</strong></li>
<li>the <strong>managed services like Cloud SQL</strong> are "doing their own thing", i.e. <strong>GCP takes care of all 
the networking stuff</strong> but keeps it <strong>isolated from "our" network</strong></li>
<li>in consequence, <strong>our VMs cannot talk to a MySQL Cloud SQL instance</strong>, because it lives on a 
different network</li>
<li>fortunately, there is a technique called
<strong><a href="https://cloud.google.com/vpc/docs/vpc-peering">VPC peering</a></strong> that can connect different VPCs 
and thus enable communication</li>
<li>to make this work, we need to <strong>"reserve" a range of IPs in "our" VPC</strong> and make it available to
Cloud SQL by peering with the <strong>Google Cloud Platform Service Producer</strong></li>
</ul>

<p>See also the <a href="https://cloud.google.com/sql/docs/mysql/private-ip#example">Example in the MySQL Guide: Learn about using private IP</a></p>

<p><a href="/img/gcp-mysql-cloud-sql-instances-create-connect-delete/mysql-cloud-sql-private-ip-vpc-peering.svg"><img src="/img/gcp-mysql-cloud-sql-instances-create-connect-delete/mysql-cloud-sql-private-ip-vpc-peering.svg" alt="Connecting to Cloud SQL via private IP through VPC peering" /></a></p>

<p><!-- generated -->
<a id='concrete-steps-to-connect-via-private-ip'> </a>
<!-- /generated --></p>

<h4>Concrete steps to connect via private IP</h4>

<video controls>
  <source src="/img/gcp-mysql-cloud-sql-instances-create-connect-delete/connect-cloud-sql-mysql-instance-via-private-ip.mp4" type="video/mp4">
Your browser does not support the video tag.
</video>

<p>In short:</p>

<ul>
<li>enable the <a href="https://console.cloud.google.com/apis/library/servicenetworking.googleapis.com">Service Networking API</a></li>
<li>navigate to the <a href="https://console.cloud.google.com/networking/networks/details/default">"default" network UI</a></li>
<li>open tab "PRIVATE SERVICE CONNECTION" and sub tab "ALLOCATED IP RANGES FOR SERVICES" and click 
the button <code>"ALLOCATE IP RANGE"</code>

<ul>
<li>give it a name, e.g. "google-internal-services"</li>
<li>and select option "Automatic" with a prefix length of 16 (this determines the number of 
possible Cloud SQL instances, see also
<a href="https://cloud.google.com/sql/docs/mysql/private-ip#allocated_range_size">the docs on Allocated range size</a>)</li>
</ul></li>
<li>open tab "PRIVATE SERVICE CONNECTION" and sub tab "PRIVATE CONNECTIONS TO SERVICES" and click 
the button <code>"CREATE CONNECTION"</code>

<ul>
<li>choose "Google Cloud Platform" in the "Connected service producer" drop down field and 
select the "google-internal-services" range that we just created for the "Assigned allocation" 
drop down field</li>
</ul></li>
<li>once the "peering" is done, you can also observe a corresponding entry in the 
<a href="https://console.cloud.google.com/networking/peering/list">VPC network peering UI</a>
<a href="/img/gcp-mysql-cloud-sql-instances-create-connect-delete/vpc-peering-servicenetworking-googleapis-com.PNG"><img src="/img/gcp-mysql-cloud-sql-instances-create-connect-delete/vpc-peering-servicenetworking-googleapis-com.PNG" alt="VPC peering connection with servicenetworking.googleapis.com" /></a></li>
<li><a href="https://console.cloud.google.com/sql/instances/create;engine=MySQL">create a new MySQL Cloud SQL instance</a>
(or modify an existing one)

<ul>
<li>under <code>Connections &gt; Instance IP assignment</code> unselect "Public IP" and select "Private IP" 
select the network "default"</li>
<li><em>Note</em>: The instance is being shutdown and restarted, i.e. this operation will lead to a 
service disruption and <strong>can take up to several minutes</strong></li>
</ul></li>
<li>once the update is done, navigate to the MySQL Cloud SQL UI of the instance and find the 
<strong>private IP</strong> in panel "Private IP address"</li>
</ul>

<p>To test the connectivity from a VM, perform the following steps:</p>

<ul>
<li><a href="/blog/gcp-compute-instance-vm-docker/#create-a-vm">create a Compute Instance VM</a> in the "default" network</li>
<li><a href="/blog/gcp-compute-instance-vm-docker/#login-via-ssh-from-the-gcp-ui">log into the VM via the UI</a></li>
<li><p><a href="https://superuser.com/a/1481211">install the <code>mysql</code> client</a> via</p>

<pre><code class="language-bash">sudo apt-get install default-mysql-client -y
</code></pre></li>
<li><p>connect to the MySQL Cloud SQL instance via</p>

<pre><code class="language-bash">mysql -h $privateIp -u root -p
</code></pre>

<p>where <code>$privateIp</code> is the private IP of the <code>mysql</code> instance</p></li>
</ul>

<p>See also the GCP MySQL docs:</p>

<ul>
<li><a href="https://cloud.google.com/sql/docs/mysql/configure-private-services-access">Configure private services access</a></li>
<li><a href="https://cloud.google.com/sql/docs/mysql/configure-private-ip">Configure private IP</a></li>
</ul>

<p><!-- generated -->
<a id='caveats-for-using-a-private-ip-only'> </a>
<!-- /generated --></p>

<h4>Caveats for using a private IP only</h4>

<ul>
<li>we need to provide some additional networking configuration (explained above)</li>
<li><p><a href="https://cloud.google.com/sql/docs/mysql/configure-private-ip?hl=en#connect_from">it's no longer possible to connect via Cloud Shell</a>:</p>

<blockquote>
  <p>Cloud Shell doesn't currently support connecting to a Cloud SQL instance that has only
  a private IP address.</p>
</blockquote></li>
<li><p><a href="https://cloud.google.com/sql/docs/mysql/configure-private-ip?hl=en#configure_an_instance_to_use_private_ip">once a private IP is assigned, it cannot be un-assigned</a>:</p>

<blockquote>
  <p>After you configure an instance to use private IP, you cannot disable private IP connectivity
  for that instance.</p>
  
  <p>If you choose to let Cloud SQL allocate your private IP for an instance, the addresses for
  all instances you later configure in that VPC network are automatically allocated in the same IP address range.</p>
</blockquote></li>
<li>we can no longer connect from "our" computer, because it doesn't live in the same private network.
This can be problematic if you are used to using UI tools like MySQL Workbench to manage your
database - please check out the following articles if this is relevant for you:

<ul>
<li><a href="https://medium.com/google-cloud/cloud-sql-with-private-ip-only-the-good-the-bad-and-the-ugly-de4ac23ce98a">Cloud SQL with private IP only: the Good, the Bad and the Ugly</a></li>
<li><a href="https://medium.com/swlh/how-to-deploy-a-cloud-sql-db-with-a-private-ip-only-using-terraform-e184b08eca64">How to Deploy a Cloud SQL DB with a Private IP only, using Terraform</a></li>
<li><a href="https://www.youtube.com/watch?v=rebyg9_eTHM">GCP | How to access Cloud SQL private IP using Cloud SQL Auth Proxy and Identity-Aware Proxy (IAP)?</a></li>
</ul></li>
</ul>

<p>But tbh, I would probably rather 
<a href="https://cloud.google.com/sdk/gcloud/reference/compute/ssh#--ssh-flag">create an SSH tunnel with the <code>gcloud</code> cli</a>
on a small Compute Instance VM via</p>

<pre><code class="language-bash">gcloud compute ssh $computeInstanceName --zone=$computeInstanceZone -- -N -L 3306:$mysqlInstanceIp:3306
</code></pre>

<p><!-- generated -->
<a id='delete-a-mysql-cloud-sql-instance'> </a>
<!-- /generated --></p>

<h2>Delete a MySQL Cloud SQL instance</h2>

<p>Once again, GCP is doing a great job documenting the process to <strong>delete a MySQL Cloud SQL 
instance</strong> in 
the <a href="https://cloud.google.com/sql/docs/mysql/delete-instance">GCP MySQL Guide: Delete instances</a>.
Please give it a read as there is at least once thing that I found quite un-intuitive: Even 
after deleting an instance, <strong>the name of the deleted instance is "blocked" for a week</strong>.</p>

<p>In my case, this created some problems, because I was making assumptions about the name in other 
parts of my code (e.g. I was expecting that the name of the instance is always <code>mysql</code>), but 
when playing around with Cloud SQL I learned too late, that I couldn't re-use the name after 
deleting the instance for testing purposes.</p>

<div class="panel panel-default">
  <div class="panel-heading">
    <strong>Update</strong>
  </div>
  <div class="panel-body bg-info">
    As of 2022-09-21 the above statement is no longer true - 
    <strong>instance names are now immediately available after deletion:</strong> 
    <br>
    <br>
    <em>
    > Cloud SQL allows the re-use of an instance name immediately after the instance is deleted. 
    </em>
    <br>
    <br>
    Source: 
    <a href="https://cloud.google.com/release-notes#September_21_2022">GCP Release Notes from 2022-09-21</a>
  </div>
</div>

<p><small>Note: If "Deletion protection" is enabled, it needs to be disabled first - which is 
usually quite a fast operation.</small></p>

<p>See the following video for a visual representation of the process (please ignore the "blocked" 
instance name issue at the end):</p>

<video controls>
  <source src="/img/gcp-mysql-cloud-sql-instances-create-connect-delete/delete-cloud-sql-mysql-instance.mp4" type="video/mp4">
Your browser does not support the video tag.
</video>

<p><!-- generated -->
<a id='using-the-gcloud-cli'> </a>
<!-- /generated --></p>

<h2>Using the <code>gcloud</code> CLI</h2>

<p>Even though I like using the UI to "explore and understand" how things are working, the goal is 
always a more "unattended" approach, e.g. via the 
<a href="/blog/gcp-compute-instance-vm-docker#set-up-the-gcloud-cli-tool"><code>gcloud</code> cli</a>. 
Since I'm gonna use a MySQL Cloud SQL instance as replacement for a <code>mysql</code> docker container for 
the next part of the <a href="/docker-php-tutorial/">Docker PHP tutorial</a>, I'll focus on creating an 
instance with a private IP address only, update the root password and set up a default database.</p>

<p>The following commands assume that you have created a master service account with owner 
permissions and activated it for <code>glcoud</code> with a default project. See also 
<a href="/blog/gcp-compute-instance-vm-docker#preconditions-project-and-owner-service-account">Preconditions: Project and Owner service account</a></p>

<video controls>
  <source src="/img/gcp-mysql-cloud-sql-instances-create-connect-delete/create-gcp-mysql-cloud-sql-instance-via-gcloud-cli.mp4" type="video/mp4">
Your browser does not support the video tag.
</video>

<p><!-- generated -->
<a id='activate-the-service-account'> </a>
<!-- /generated --></p>

<h3>Activate the service account</h3>

<pre><code class="language-bash">project_id=pl-dofroscra-p
gcloud auth activate-service-account --key-file=./gcp-master-service-account-key.json --project=${project_id}
</code></pre>

<p><!-- generated -->
<a id='enable-the-necessary-apis'> </a>
<!-- /generated --></p>

<h3>Enable the necessary APIs</h3>

<ul>
<li><a href="https://cloud.google.com/sdk/gcloud/reference/services/enable"><code>gcloud services enable</code> reference</a></li>
</ul>

<pre><code class="language-bash">gcloud services enable \
  compute.googleapis.com \
  sqladmin.googleapis.com \
  cloudresourcemanager.googleapis.com \
  servicenetworking.googleapis.com
</code></pre>

<p><code>cloudresourcemanager.googleapis.com</code> is necessary to create the IP range allocation in the 
next step.</p>

<p><!-- generated -->
<a id='create-an-ip-range-allocation'> </a>
<!-- /generated --></p>

<h3>Create an IP range allocation</h3>

<ul>
<li><a href="https://cloud.google.com/sdk/gcloud/reference/compute/addresses/create"><code>gcloud compute addresses create</code> reference</a></li>
</ul>

<pre><code class="language-bash">private_ip_range_name="internal-gcp-services"
network="default"
ip_range_network_address="10.111.0.0"

gcloud compute addresses create "${private_ip_range_name}" \
  --global \
  --purpose=VPC_PEERING \
  --prefix-length=16 \
  --addresses="${ip_range_network_address}" \
  --description="Peering range for GCP Services" \
  --network="${network}"
</code></pre>

<p>The <code>--addresses</code> flag can be used to define the network address of the defined range. If it is 
not given, GCP will choose a random one.</p>

<p><!-- generated -->
<a id='create-the-vpc-peering-with-servicenetworking-googleapis-com'> </a>
<!-- /generated --></p>

<h3>Create the VPC peering with <code>servicenetworking.googleapis.com</code></h3>

<ul>
<li><a href="https://cloud.google.com/sdk/gcloud/reference/services/vpc-peerings/connect"><code>gcloud services vpc-peerings connect</code> reference</a></li>
</ul>

<pre><code class="language-bash">private_ip_range_name="internal-gcp-services"
network="default"

gcloud services vpc-peerings connect \
  --service=servicenetworking.googleapis.com \
  --ranges="${private_ip_range_name}" \
  --network="${network}"
</code></pre>

<p><!-- generated -->
<a id='create-the-mysql-instance'> </a>
<!-- /generated --></p>

<h3>Create the <code>mysql</code> instance</h3>

<ul>
<li><a href="https://cloud.google.com/sdk/gcloud/reference/beta/sql/instances/create"><code>gcloud beta sql instances create</code> reference</a></li>
<li><a href="https://cloud.google.com/sql/docs/mysql/create-instance">GCP MySQL Guide: Create instances</a></li>
<li><a href="https://cloud.google.com/sql/docs/mysql/configure-private-ip#new-private-instance">GCP MySQL Guide: Configure an instance to use private IP</a></li>
</ul>

<p><strong>Caution</strong>: The <code>--allocated-ip-range-name</code> option is currently (2022-09-04) only available in 
the <a href="https://cloud.google.com/sdk/gcloud/reference/beta"><code>beta</code> tools of the <code>gcloud</code> cli</a>. 
You might need to install them first via 
<a href="https://cloud.google.com/sdk/gcloud/reference/components/install"><code>gcloud components install beta</code></a>.</p>

<pre><code class="language-bash">mysql_instance_name="mysql"
version="MYSQL_8_0" # see https://cloud.google.com/sdk/gcloud/reference/sql/instances/create#--database-version
cpus="1"
memory="3840MB"
region="us-central1"
private_ip_range_name="internal-gcp-services"
network="default"

gcloud beta sql instances create "${mysql_instance_name}" \
  --database-version="${version}" \
  --cpu="${cpus}" \
  --memory="${memory}" \
  --region="${region}" \
  --network="${network}" \
  --no-assign-ip \
  --allocated-ip-range-name="${private_ip_range_name}"
</code></pre>

<p>The <code>--no-assign-ip</code> flag is responsible for not assigning a <em>public</em> IP.</p>

<p><!-- generated -->
<a id='set-the-root-password'> </a>
<!-- /generated --></p>

<h4>Set the root password</h4>

<ul>
<li><a href="https://cloud.google.com/sdk/gcloud/reference/sql/users/set-password"><code>gcloud sql users set-password</code> reference</a></li>
<li><a href="https://cloud.google.com/sql/docs/mysql/create-manage-users#change-pwd">GCP MySQL Guide: Manage users with built-in authentication: Change a user password</a></li>
</ul>

<pre><code class="language-bash">mysql_instance_name="mysql"
root_password=12345678

gcloud sql users set-password root \
  --host=% \
  --instance "${mysql_instance_name}" \
  --password "${root_password}"
</code></pre>

<p>Using <code>--host=%</code> will allow access from any remote host, see 
<a href="https://cloud.google.com/sdk/gcloud/reference/sql/users/set-password#--host">docu for the <code>--host</code> parameter </a></p>

<blockquote>
  <p>Cloud SQL user's host name expressed as a specific IP address or address range. % denotes an 
  unrestricted host name. Applicable flag for MySQL instances; ignored for all other engines.</p>
</blockquote>

<p>FYI: Instead of "root", we could also use a different username like "application_user" and MySQL 
would create that user automatically with the given password (without any privileges).</p>

<p><!-- generated -->
<a id='create-a-default-database'> </a>
<!-- /generated --></p>

<h4>Create a default database</h4>

<ul>
<li><a href="https://cloud.google.com/sdk/gcloud/reference/sql/databases/create"><code>gcloud sql databases create</code> reference</a></li>
<li><a href="https://cloud.google.com/sql/docs/mysql/create-manage-databases#create">GCP MySQL Guide: Create and manage databases: Create a database on the Cloud SQL instance</a></li>
</ul>

<pre><code class="language-bash">mysql_instance_name="mysql"
default_database="application_db"

gcloud sql databases create "${default_database}" \
  --instance="${mysql_instance_name}" \
  --charset=utf8mb4 \
  --collation=utf8mb4_unicode_ci
</code></pre>

<h2>Wrapping up</h2>

<p>Congratulations, you made it! If some things are not completely clear by now, don't hesitate to
leave a comment. You are now able to manage MySQL databases on GCP via the UI as well as via the
<code>gcloud</code> cli.</p>
                <hr />
                <h3>Wanna stay in touch?</h3>
                <p>Since you ended up on this blog, chances are pretty high that you're into Software Development
                (probably PHP, Laravel, Docker or Google Big Query) and I'm a big fan of feedback and networking.
                </p><p>
                So - if you'd like to stay in touch, feel free to shoot me an email with a couple of words about yourself and/or
                connect with me on
                <a href="https://www.linkedin.com/in/pascallandau">LinkedIn</a> or
                <a href="https://twitter.com/PascalLandau">Twitter</a>
                or simply subscribe to my <a href="https://www.pascallandau.com/feed.xml">RSS feed</a>
                or go the crazy route and subscribe via mail
                and don't forget to leave a comment :)
                </p>
                <!-- Begin Mailchimp Signup Form -->
                <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
                <style type="text/css">
                    #mc_embed_signup{background:#bae1ff; clear:left; font:14px Helvetica,Arial,sans-serif; border-radius: 20px}
                    #mc_embed_signup h4 {padding:1em 0 0 1em}
                    #mc-embedded-subscribe-form input[type=checkbox]{display: inline; width: auto;margin-right: 10px;}
                    #mergeRow-gdpr {margin-top: 20px;}
                    #mergeRow-gdpr fieldset label {font-weight: normal;}
                    #mc-embedded-subscribe-form .mc_fieldset{border:none;min-height: 0px;padding-bottom:0px;}
                </style>
                <div id="mc_embed_signup">
                    <h4 id="newsletter">Subscribe to posts via mail</h4>
                    <form action="https://pascallandau.us20.list-manage.com/subscribe/post?u=89e1c97fa614ded06a44fbcfd&amp;id=852c78303c" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
                        <div id="mc_embed_signup_scroll">
                            <div class="mc-field-group">
                                <label for="mce-EMAIL">Email Address </label>
                                <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
                            </div>
                            <div class="mc-field-group">
                                <label for="mce-FNAME">First Name </label>
                                <input type="text" value="" name="FNAME" class="required" id="mce-FNAME">
                            </div>
                            <div id="mce-responses" class="clear">
                                <div class="response" id="mce-error-response" style="display:none"></div>
                                <div class="response" id="mce-success-response" style="display:none"></div>
                            </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                            <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_89e1c97fa614ded06a44fbcfd_852c78303c" tabindex="-1" value=""></div>
                            <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
                            <div id="mergeRow-gdpr" class="mergeRow gdpr-mergeRow content__gdprBlock mc-field-group">
                                <div class="content__gdprLegal">
                                    <small>
                                        We use Mailchimp as our newsletter provider. By clicking subscribe, you acknowledge that your
                                        information will be transferred to Mailchimp for processing.
                                        <a href="https://mailchimp.com/legal/" target="_blank" rel="nofollow">Learn more about Mailchimp's privacy practices here.</a>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';fnames[3]='ADDRESS';ftypes[3]='address';fnames[4]='PHONE';ftypes[4]='phone';fnames[5]='BIRTHDAY';ftypes[5]='birthday';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
                <!--End mc_embed_signup-->
                <div style="text-align:center; margin-top:1em;">
                    <img src="/img/waving-bear.gif" alt="Waving bear" style="max-width:416px"/>
                </div>
                <h2>Comments</h2>
                <div id="disqus_thread"></div>
                <script>
                     var disqus_config = function () {
                        this.page.url = "https://www.pascallandau.com/blog/gcp-mysql-cloud-sql-instances-create-connect-delete/";
                                                     this.page.identifier = "gcp-mysql-cloud-sql-instances-create-connect-delete";
                                              };
                    (function() {  // DON'T EDIT BELOW THIS LINE
                        var d = document, s = d.createElement('script');

                        s.src = '//pascallandau.disqus.com/embed.js';

                        s.setAttribute('data-timestamp', +new Date());
                        (d.head || d.body).appendChild(s);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
            </div>
        </div>
    </div>
</article>

<hr>

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="https://twitter.com/PascalLandau">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                        </a>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/in/pascallandau">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/paslandau/">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                        </a>
                    </li>
                    <li>
                        <a href="https://www.youtube.com/channel/UC8hVNCGAtz1DvOOpSQ3Nfzw">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-youtube fa-stack-1x fa-inverse"></i>
                                </span>
                        </a>
                    </li>
                    <li>
                        <a href="https://www.pascallandau.com/feed.xml">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                                </span>
                        </a>
                    </li>
                </ul>
                <p class="copyright text-muted">&copy; <a href="https://www.pascallandau.com">www.pascallandau.com</a> 2023                    built with <a href="https://github.com/tightenco/jigsaw">Jigsaw</a></p>
            </div>
        </div>
    </div>
</footer>
    <img src="https://ssl-vg03.met.vgwort.de/na/d03d0bc34d88426c8f84de9fcb83e868" width="1" height="1" alt=""/>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>
<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>
<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js"></script>
<!-- Custom JavaScript -->
<script src="/js/main.js"></script>
<!-- Code highlighting 
     See source/img/highlight-js-languages.PNG for an overview of the selected languages 
     The files can be re-compiled at https://highlightjs.org/download/
     -->
<script src="/js/highlight.min.js"></script>

<script type='text/javascript'>
    hljs.highlightAll();
    // show the hidden blog only locally
    if(window.location.href.startsWith("http://localhost:8000/")){
        $('#navbar').prepend('<li><a href="/blog-hidden/">HIDDEN Blog</a></li>');
    }
</script>
</body>

</html>
